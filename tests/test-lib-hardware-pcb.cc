#include <cppunit/TestFixture.h>
#include <cppunit/extensions/HelperMacros.h>

#include "hardware/Pcb.h"

#include "hardware/comm/Dummy.h"
#include "hardware/gps/Dummy.h"

#include "data/MEvent.h"

#include "network/transfer/None.h"

#include "test-lib-hardware-pcb.h"

CPPUNIT_TEST_SUITE_REGISTRATION( HardwareTest );

void HardwareTest::run(bo::hardware::comm::Base& comm, unsigned int expectedSamples) {
  bo::hardware::gps::Dummy gps(comm, 4800);

  bo::hardware::Pcb pcb(comm, gps);

  unsigned int count = 0;

  while (pcb.isOpen()) {

    bo::data::Event::AP event = pcb.read();

    bo::network::transfer::None transfer;

    if (event.get() != 0) {
      bo::data::MEvent& mevent = dynamic_cast<bo::data::MEvent&>(*event);

      if (!mevent.getWaveform().isEmpty()) {
	// TODO
	//std::cout << std::endl;
	//std::cout << "data: '" << mevent.getRawData() << "'\n";
	//std::cout << "format: " << *(mevent.getWaveform().getArray().getFormat()) << std::endl;

	//std::cout << transfer.eventToString(mevent) << std::endl;
	//std::cout << *event << std::endl;
	count++;
      }
    }

  }

  CPPUNIT_ASSERT_EQUAL(expectedSamples, count);
}

void HardwareTest::setUp() {
}

void HardwareTest::tearDown() {
}

void HardwareTest::testV4() {
  bo::hardware::comm::Dummy comm;

  comm.setBaudRate(19200);

  comm.addReceivedLine("BLSEC,185630,190810,A,4729.2852,N,01904.2683,E,AB852D");
  comm.addReceivedLine("BLSEC,185631,190810,A,4729.2856,N,01904.2688,E,D1ABEA");
  comm.addReceivedLine("BLSIG,F133E6,CF4,860");
  comm.addReceivedLine("BLSIG,F1341D,450,77C");

  run(comm, 2);
}

void HardwareTest::testV6() {
  bo::hardware::comm::Dummy comm;

  comm.setBaudRate(19200);

  comm.addReceivedLine("BLSEC,0833CC,A,131531,200810,4808.1189,N,01132.6299,E,576.5000,M,06");
  comm.addReceivedLine("BLSEC,2E59FE,A,131532,200810,4808.1187,N,01132.6301,E,577.2000,M,06");
  comm.addReceivedLine("BLSEC,54802F,A,131533,200810,4808.1186,N,01132.6302,E,577.6000,M,06");
  comm.addReceivedLine("BLSEC,7AA661,A,131534,200810,4808.1185,N,01132.6303,E,577.7000,M,06");
  comm.addReceivedLine("BLSEC,A0CC93,A,131535,200810,4808.1182,N,01132.6305,E,578.6000,M,06");
  comm.addReceivedLine("BLSEC,C6F2C4,A,131536,200810,4808.1180,N,01132.6307,E,579.3000,M,06");
  comm.addReceivedLine("BLSEC,ED18F6,A,131537,200810,4808.1179,N,01132.6309,E,579.8000,M,06");
  comm.addReceivedLine("BLSEQ,F67E15,667E667D6A7E707F787F817F887F8C808F80907F8F809381968191808A7F847F7F7F737E647D587D507D487B467B4D7C587C647C747D887F9780A181A983AF84B084AD84AA83A782A0819A80957F907F8A7D847E807E7C7D777B747C727C727B717B717D727F737F75807682778279827A817A817B807C7E7C7C7A7B797B777A");
  comm.addReceivedLine("BLSEQ,00D13B,4C7E1A8103831E834F7F7F7DB07EDE7DF37AF17BEC7FE580D17DB77EA3828D81747E6A7F6D81697F627C607E61805F7E617E69816F827280787F79807780767E7B7D797D727D6F7D747E757E727F73807D80837E847D867E877E827D7D7D7B7F777E737C737C767D767C7A7D817E8580858089818B818B828D819180917E927D");

  run(comm, 2);
}


void HardwareTest::testFirmware27b() {
  bo::hardware::comm::Dummy comm;

  comm.setBaudRate(38400);

  comm.addReceivedLine("BS,11C2CC,A,084638,200311,4808.1313,N,01132.6202,E,532.8,09,27b");
  comm.addReceivedLine("BS,37E912,A,084639,200311,4808.1313,N,01132.6201,E,532.9,09,27b");
  comm.addReceivedLine("BS,5E0F58,A,084640,200311,4808.1312,N,01132.6201,E,532.9,09,27b");
  comm.addReceivedLine("BS,84359D,A,084641,200311,4808.1312,N,01132.6201,E,532.8,09,27b");
  comm.addReceivedLine("BS,AA5BE3,A,084642,200311,4808.1312,N,01132.6201,E,532.8,09,27b");
  comm.addReceivedLine("BS,D08229,A,084643,200311,4808.1312,N,01132.6201,E,532.8,09,27b");
  comm.addReceivedLine("BS,F6A86F,A,084644,200311,4808.1312,N,01132.6201,E,532.7,09,27b");
  comm.addReceivedLine("BS,1CCEB4,A,084645,200311,4808.1312,N,01132.6201,E,532.7,09,27b");
  comm.addReceivedLine("BS,42F4FA,A,084646,200311,4808.1312,N,01132.6201,E,532.6,09,27b");
  comm.addReceivedLine("BS,691B40,A,084647,200311,4808.1312,N,01132.6201,E,532.5,09,27b");
  comm.addReceivedLine("BD,8EBD1A,9D6F9B719377897C7E8073856C89688C628D608D618E60905B9259915A9253974B995B8D797D917699739B6F9E6D9F6EA16EA36CA36BA16F9D7395768B78867B857E827E7E7D7F7D857B897A8679837A827D7F7F7A8077807783768574847284728673867583768178817B807C7F7B7E7A7F7B807A8079807981798379837782");
  comm.addReceivedLine("BD,E0DBA5,7EB282CE82D980D47DBD7A9D7876744A7123700874007E04841289269043925E8F738E878B948799889C879B8599849881997D9C7EA479A67AA97CA87BA27A997991778A78867881767B78797B787D78817D81827F857F8B7D8D7A8A7A867A807B7B7E797D767C757C777B7879777B787D787F788079817B7F7E7E827D857C86");
  // 2011-03-20 08:46:47.986441018 48.135521 11.543671 533 AndreasW donar A 9 2 64 8 9D6F9B719377897C7E8073856C89688C628D608D618E60905B9259915A9253974B995B8D797D917699739B6F9E6D9F6EA16EA36CA36BA16F9D7395768B78867B857E827E7E7D7F7D857B897A8679837A827D7F7F7A8077807783768574847284728673867583768178817B807C7F7B7E7A7F7B807A8079807981798379837782 LT&nbsp;22 27b 38400 SiRF
  // 2011-03-20 08:46:47.986440988 48.135521 11.543669 532 username password A 9 2 64 8 9D6F9B719377897C7E8073856C89688C628D608D618E60905B9259915A9253974B995B8D797D917699739B6F9E6D9F6EA16EA36CA36BA16F9D7395768B78867B857E827E7E7D7F7D857B897A8679837A827D7F7F7A8077807783768574847284728673867583768178817B807C7F7B7E7A7F7B807A8079807981798379837782 debT&nbsp;0.9.2 27b 384200 SiRF
  //
  run(comm, 2);

  comm.addReceivedLine("BS,EA6910,A,091448,200311,4808.1294,N,01132.6179,E,544.0,06,27b");
  comm.addReceivedLine("BS,108F55,A,091449,200311,4808.1295,N,01132.6180,E,543.5,06,27b");
  comm.addReceivedLine("BS,36B59A,A,091450,200311,4808.1296,N,01132.6181,E,543.0,06,27b");
  comm.addReceivedLine("BS,5CDBDF,A,091451,200311,4808.1297,N,01132.6182,E,542.5,06,27b");
  comm.addReceivedLine("BS,830224,A,091452,200311,4808.1298,N,01132.6182,E,542.2,06,27b");
  comm.addReceivedLine("BS,A92869,A,091453,200311,4808.1299,N,01132.6183,E,541.6,06,27b");
  comm.addReceivedLine("BS,CF4EAE,A,091454,200311,4808.1300,N,01132.6184,E,541.3,06,27b");
  comm.addReceivedLine("BS,F574F3,A,091455,200311,4808.1300,N,01132.6184,E,541.3,06,27b");
  comm.addReceivedLine("BD,0FE292,997F8A807E7F7E7E80807B82777F7A7D7C7F7A80797F7C7D7E7F7E80807F827E817F7C807880787F7A807B7F7D7F7F7E807F807F807E807F7F7F7F7F7F7E807E877E907E8E7E847F7B7F797E797F797F797F7A7E7B7F7C7F7C7F7C7F7D7E7F7F807F7F7F7E7E7E7E7F7E7E7F7D7F7F7E827D837F807F7F7E807F7F7F7D7F7C7E");

  run(comm, 1);
  // 2011-03-20 09:14:55.692753864 48.135519 11.543627 539 AndreasW donar A 6 2 64 8 997F8A807E7F7E7E80807B82777F7A7D7C7F7A80797F7C7D7E7F7E80807F827E817F7C807880787F7A807B7F7D7F7F7E807F807F807E807F7F7F7F7F7F7E807E877E907E8E7E847F7B7F797E797F797F797F7A7E7B7F7C7F7C7F7C7F7D7E7F7F807F7F7F7E7E7E7E7F7E7E7F7D7F7F7E827D837F807F7F7E807F7F7F7D7F7C7E LT&nbsp;22 27b 38400 SiRF


   comm.addReceivedLine("BS,3DB260,A,094917,200311,4808.1288,N,01132.6248,E,539.7,08,27b");
   comm.addReceivedLine("BS,63D8A4,A,094918,200311,4808.1288,N,01132.6248,E,539.6,08,27b");
   comm.addReceivedLine("BS,89FEE9,A,094919,200311,4808.1288,N,01132.6248,E,539.5,08,27b");
   comm.addReceivedLine("BS,B0252D,A,094920,200311,4808.1288,N,01132.6248,E,539.5,08,27b");
   comm.addReceivedLine("BS,D64B71,A,094921,200311,4808.1288,N,01132.6249,E,539.6,08,27b");
   comm.addReceivedLine("BS,FC71B6,A,094922,200311,4808.1288,N,01132.6249,E,539.5,08,27b");
   comm.addReceivedLine("BS,2297FA,A,094923,200311,4808.1288,N,01132.6249,E,539.5,08,27b");
   comm.addReceivedLine("BS,48BE3F,A,094924,200311,4808.1288,N,01132.6248,E,539.4,08,27b");
   comm.addReceivedLine("BS,6EE483,A,094925,200311,4808.1289,N,01132.6248,E,539.3,08,27b");
   comm.addReceivedLine("BS,950AC7,A,094926,200311,4808.1288,N,01132.6248,E,539.3,08,27b");
   comm.addReceivedLine("BS,BB310C,A,094927,200311,4808.1288,N,01132.6249,E,539.3,08,27b");
   comm.addReceivedLine("BS,E15750,A,094928,200311,4808.1289,N,01132.6248,E,539.2,08,27b");
   comm.addReceivedLine("BS,077D95,A,094929,200311,4808.1289,N,01132.6248,E,539.1,08,27b");
   comm.addReceivedLine("BS,2DA3D9,A,094930,200311,4808.1289,N,01132.6248,E,538.9,08,27b");
   comm.addReceivedLine("BS,53CA1D,A,094931,200311,4808.1290,N,01132.6247,E,538.8,08,27b");
   comm.addReceivedLine("BD,55330E,9B7F947F877F837D867E7E8071806E7E717E6E816B80727E767F71816F80747E76807381717F757E77807680787E7B7D7E818081837F857E867F8681877F857E847E837F847E837E817E817E837E857F857F877E887E8A7E8B7F8B7E8A7E887E877E867F837E807E7E7E7E7E7E7F7A7E787E777E777F7780747E747E757F7580");

   run(comm, 1);
   //2011-03-20 09:49:31.036957969 48.135514 11.543663 538 AndreasW donar A 8 2 64 8 9B7F947F877F837D867E7E8071806E7E717E6E816B80727E767F71816F80747E76807381717F757E77807680787E7B7D7E818081837F857E867F8681877F857E847E837F847E837E817E817E837E857F857F877E887E8A7E8B7F8B7E8A7E887E877E867F837E807E7E7E7E7E7E7F7A7E787E777E777F7780747E747E757F7580 LT&nbsp;22 27b 38400 SiRF
}
